# 네트워크 주소 및 소켓 유틸리티

## 개요

본 문서는 `CPPServer` 프로젝트 내에서 네트워크 통신을 위해 사용되는 `NetAddress` 클래스와 `SocketUtils` 클래스에 대해 설명합니다. 이 클래스들은 Winsock API를 보다 편리하게 사용하고 네트워크 관련 작업을 캡슐화하여 코드의 가독성과 재사용성을 높이는 것을 목표로 합니다.

## `NetAddress` 클래스

`NetAddress` 클래스는 네트워크 주소 정보(IP 주소와 포트 번호)를 관리합니다. Winsock의 `SOCKADDR_IN` 구조체를 래핑하여 사용 편의성을 제공합니다.

`SOCKADDR_IN` 구조체를 사용할 때 유의할 점은 다음과 같습니다:
- `sin_family`: 주소 체계를 나타내며, IPv4의 경우 항상 `AF_INET`으로 설정해야 합니다.
- `sin_port`, `sin_addr`: 각각 포트 번호와 IP 주소를 나타내며, 이 값들은 네트워크 바이트 순서(빅 엔디안)로 지정되어야 합니다.
`NetAddress` 클래스는 이러한 세부 사항(예: 포트 번호의 바이트 순서 변환)을 내부적으로 처리하여 개발자가 보다 쉽게 주소 정보를 다룰 수 있도록 돕습니다.

### 주요 기능

-   **생성자**:
    -   `NetAddress()`: 기본 생성자.
    -   `NetAddress(SOCKADDR_IN sockAddr)`: `SOCKADDR_IN` 구조체로 초기화합니다.
    -   `NetAddress(wstring ip, uint16 port)`: IP 주소(문자열)와 포트 번호로 초기화합니다.
-   **멤버 함수**:
    -   `SOCKADDR_IN& GetSockAddr()`: 내부 `SOCKADDR_IN` 구조체의 참조를 반환합니다.
    -   `wstring GetIpAddress()`: IP 주소를 와이드 문자열 형태로 반환합니다.
    -   `uint16 GetPort()`: 포트 번호를 반환합니다 (네트워크 바이트 순서에서 호스트 바이트 순서로 변환).
-   **정적 멤버 함수**:
    -   `static IN_ADDR Ip2Address(const WCHAR* ip)`: IP 주소 문자열을 `IN_ADDR` 구조체로 변환합니다. (내부적으로 `InetPtonW` 사용)

### 사용 예시

```cpp
// IP 주소와 포트로 NetAddress 객체 생성
NetAddress serverAddr(L"127.0.0.1", 7777);

// SOCKADDR_IN 구조체 얻기
SOCKADDR_IN sockAddr = serverAddr.GetSockAddr();

// IP 주소와 포트 얻기
wstring ip = serverAddr.GetIpAddress();
uint16 port = serverAddr.GetPort();
```

## `SocketUtils` 클래스

`SocketUtils` 클래스는 Winsock 소켓 프로그래밍에 필요한 다양한 유틸리티 함수들을 정적 멤버 함수 형태로 제공합니다. 소켓 생성, 옵션 설정, 주소 바인딩, 리슨, 연결 해제 등의 일반적인 작업과 함께 Winsock 확장 함수 로딩을 지원합니다.

### 주요 기능

-   **초기화 및 정리**:
    -   `static void Init()`: Winsock 라이브러리를 초기화하고 (`WSAStartup`), `ConnectEx`, `DisconnectEx`, `AcceptEx`와 같은 Winsock 확장 함수들의 포인터를 로드합니다. 이 함수는 프로그램 시작 시 한 번 호출되어야 합니다.
    -   `static void Clear()`: Winsock 라이브러리 사용을 정리합니다 (`WSACleanup`). 프로그램 종료 시 호출될 수 있습니다.
-   **확장 함수 바인딩**:
    -   `static bool BindWindowsFunction(SOCKET socket, GUID guid, LPVOID* fn)`: 특정 GUID에 해당하는 Winsock 확장 함수를 로드합니다. `Init()` 내부에서 사용됩니다. (`WSAIoctl` 및 `SIO_GET_EXTENSION_FUNCTION_POINTER` 사용)
-   **소켓 생성 및 관리**:
    -   `static SOCKET CreateSocket()`: TCP 소켓을 생성합니다 (`WSASocket`).
    -   `static void Close(SOCKET socket)`: 소켓을 닫습니다 (`closesocket`).
-   **소켓 옵션 설정 (내부적으로 `SetSockOpt` 템플릿 함수 사용)**:
    -   `static bool SetLinger(SOCKET socket, uint16 onoff, uint16 linger)`: `SO_LINGER` 옵션을 설정합니다.
    -   `static bool SetReuseAddress(SOCKET socket, bool flag)`: `SO_REUSEADDR` 옵션을 설정합니다.
    -   `static bool SetRecvBufferSize(SOCKET socket, int32 size)`: 수신 버퍼 크기 (`SO_RCVBUF`)를 설정합니다.
    -   `static bool SetSendBufferSize(SOCKET socket, int32 size)`: 송신 버퍼 크기 (`SO_SNDBUF`)를 설정합니다.
    -   `static bool SetTcpNoDelay(SOCKET socket, bool flag)`: 네이글 알고리즘 사용 여부 (`TCP_NODELAY`)를 설정합니다.
    -   `static bool SetUpdateAcceptSocket(SOCKET socket, SOCKET listenSocket)`: `accept`된 소켓이 리슨 소켓의 속성을 상속하도록 설정합니다. (`SO_UPDATE_ACCEPT_CONTEXT`)
-   **소켓 작업**:
    -   `static bool Bind(SOCKET socket, NetAddress netAddr)`: 소켓을 특정 네트워크 주소에 바인딩합니다 (`bind`).
    -   `static bool BindAnyAddress(SOCKET socket, uint16 port)`: 소켓을 사용 가능한 아무 IP 주소와 지정된 포트에 바인딩합니다. (`INADDR_ANY` 사용)
    -   `static bool Listen(SOCKET socket, int32 backlog = SOMAXCONN)`: 소켓을 리슨 상태로 만듭니다 (`listen`).
-   **템플릿 함수**:
    -   `template<typename T> static inline bool SetSockOpt(SOCKET socket, int32 level, int32 optName, T optVal)`: 다양한 타입의 소켓 옵션을 설정할 수 있는 제네릭 함수입니다 (`setsockopt`).

### `Init()` 함수의 중요성

`SocketUtils::Init()` 함수는 Winsock을 사용하기 전에 반드시 호출되어야 합니다. 이 함수는 `WSAStartup()`을 호출하여 Winsock 라이브러리를 초기화하고, 동적으로 로드해야 하는 `ConnectEx`, `DisconnectEx`, `AcceptEx` 등의 확장 함수 포인터를 가져옵니다. 이 확장 함수들은 고성능 네트워크 프로그래밍에 필수적입니다.

```cpp
// 메인 함수 시작 부분 등에서 호출
SocketUtils::Init();

// ... 소켓 프로그래밍 로직 ...

// 프로그램 종료 시
SocketUtils::Clear();
```

### 사용 예시

```cpp
// 리슨 소켓 생성
SOCKET listenSocket = SocketUtils::CreateSocket();
if (listenSocket == INVALID_SOCKET)
{
    // 오류 처리
    return;
}

// 주소 재사용 옵션 설정
if (SocketUtils::SetReuseAddress(listenSocket, true) == false)
{
    // 오류 처리
    SocketUtils::Close(listenSocket);
    return;
}

// 특정 주소와 포트에 바인딩
NetAddress listenAddr(L"127.0.0.1", 7777);
if (SocketUtils::Bind(listenSocket, listenAddr) == false)
{
    // 오류 처리
    SocketUtils::Close(listenSocket);
    return;
}

// 리슨 시작
if (SocketUtils::Listen(listenSocket) == false)
{
    // 오류 처리
    SocketUtils::Close(listenSocket);
    return;
}

// ... 클라이언트 접속 대기 및 처리 ...

SocketUtils::Close(listenSocket);
```

## Winsock 확장 함수

`SocketUtils`는 `ConnectEx`, `DisconnectEx`, `AcceptEx`와 같은 Winsock 확장 함수를 사용합니다. 이 함수들은 표준 Winsock 함수보다 향상된 성능과 기능을 제공하며, 특히 I/O 완료 포트(IOCP)와 같은 고성능 비동기 I/O 모델과 함께 사용될 때 유용합니다.

-   `ConnectEx`: 비동기 연결을 시작합니다.
-   `DisconnectEx`: 소켓 연결을 끊고, 선택적으로 재사용을 위해 소켓을 준비합니다.
-   `AcceptEx`: 비동기적으로 새 연결을 수락하고, 로컬 및 원격 주소 정보를 가져올 뿐만 아니라, **클라이언트가 보낸 첫 번째 데이터 블록을 함께 수신할 수 있습니다.**

이러한 함수들은 `WSAIoctl`을 통해 `SIO_GET_EXTENSION_FUNCTION_POINTER` 제어 코드를 사용하여 런타임에 함수 포인터를 얻어와야 합니다. `SocketUtils::BindWindowsFunction`과 `SocketUtils::Init` 함수가 이 과정을 처리합니다.

특히 `AcceptEx` 함수의 경우, 호출 시 제공된 출력 버퍼(`lpOutputBuffer`)에 클라이언트로부터 수신된 첫 데이터, 서버의 로컬 주소, 클라이언트의 원격 주소 정보가 함께 기록되어 반환됩니다. 따라서 이 버퍼에서 각 정보를 올바르게 파싱하는 과정(예: `GetAcceptExSockaddrs` 함수 사용)이 필요합니다. `SocketUtils`는 이러한 복잡성을 일부 감추고 사용 편의성을 제공하려는 목적을 가집니다.

## 결론

`NetAddress`와 `SocketUtils` 클래스는 `CPPServer` 프로젝트에서 Winsock API를 활용한 네트워크 프로그래밍의 복잡성을 줄이고, 관련 코드의 구조화 및 재사용성을 높이는 데 기여합니다. 특히 `SocketUtils::Init`을 통해 Winsock 및 주요 확장 함수들을 적절히 초기화하는 것은 안정적인 네트워크 통신을 위한 필수 과정입니다.
